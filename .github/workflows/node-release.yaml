name: "Release"
on:
  workflow_call:
    inputs:
      build_script:
        type: string
        description: "Build script to be executed"
        default: 'npm run build'
      dockerize:
        type: string
        description: "Determines if docker image will be created"
        default: 'false'
      before_dockerize:
        description: "Shell commands before build docker image"
        type: string
        default: ''
      stage_version:
        description: "Stage file version prefix"
        type: string
        default: 'v1'
    secrets:
      PERSONAL_ACCESS_TOKEN:
        required: true
      DOCKERHUB_USERNAME:
      DOCKERHUB_PASS:

jobs:
  # ***********************************
  # Job: Build Packages
  # ***********************************
  build:
    name: Build Packages
    uses: panates/github-actions/.github/workflows/node-build.yaml@dev
    with:
      build_script:  ${{ inputs.build_script }}
    secrets:
      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}


  # ***********************************
  # Job: Publish npm packages
  # ***********************************
  npm_publish:
    name: 'Publish npm packages'
    needs:
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: 'artifacts'
          path: './__artifacts__'

      - name: "Create ZIP files"
        uses: panates/github-actions/.github/actions/node-release-npm@dev


#  # ***********************************
#  # Job: Create GitHub release
#  # ***********************************
#  github_release:
#    name: 'Create Github Release'
#    needs:
#      - build
#    runs-on: ubuntu-latest
#    steps:
#      - name: Download artifacts
#        uses: actions/download-artifact@v4
#        with:
#          name: 'artifacts'
#          path: './__artifacts__'
#
#      - name: "Create ZIP files"
#        uses: panates/github-actions/.github/actions/github-release-artifacts@dev
#
#      - name: Create GitHub Release
#        id: create_release
#        uses: ncipollo/release-action@v1
#        with:
#          tag: ${{ needs.build.outputs.lastTag }}
#          bodyFile: "__artifacts__/COMMIT_CHANGELOG.md"
#          artifacts: "__release__/**/*"
#          token: "${{ secrets.PERSONAL_ACCESS_TOKEN }}"
#          draft: false
#          prerelease: false
#          replacesArtifacts: true

#  # ***********************************
#  # Job: Create Docker Images
#  # ***********************************
#  dockerize:
#    name: 'Create Docker Images'
#    if: ${{ needs.publish_packages.outputs.appFiles != '' }}
#    needs: publish_packages
#    strategy:
#      matrix:
#        releaseFile: ${{ fromJson(needs.publish_packages.outputs.appFilesArray) }}
#    uses: kimvar-inc/manifests/.github/workflows/docker-publish.yaml@main
#    with:
#      file_basename: ${{matrix.releaseFile}}
#      image_prefix: "pntdockerhub/kimvar-"
#      before_dockerize: ${{ inputs.before_dockerize }}
#      stage_version: ${{ inputs.stage_version }}
#    secrets:
#      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
#      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
#      DOCKERHUB_PASS: ${{ secrets.DOCKERHUB_PASS }}
